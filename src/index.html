<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>test_web3.js</title>

    <link rel="stylesheet" type="text/css" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">

    <script src="../node_modules/web3/dist/web3.js"></script>

</head>
<body>
    <div class="container">
        <form>
            <div>
                <h3>Insert User</h3>
                <h4 id="instructor"></h4>
            </div>
            
            <div class="form-group">
                <label for="address" class="col-lg-2 control-label">User address</label>
                <input id="address" type="text">
            </div>
            <div class="form-group">
                <label for="name" class="col-lg-2 control-label">User Name</label>
                <input id="name" type="text">   
            </div>
            <div class="form-group">
                <label for="identity" class="col-lg-2 control-label">User Age</label>
                <input id="identity" type="text">
            </div>
            <div class="form-group">
                <label for="sold" class="col-lg-2 control-label">User sold</label>
                <input id="sold" type="text">
            </div>

            <button id="button" class="btn btn-primary">Insert User</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
       if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        web3.eth.defaultAccount = web3.eth.accounts[0];
        console.log("user accounts:")
        console.log(web3.eth.defaultAccount);


        var userManagerContrat = web3.eth.contract(
[
    {
        "constant": false,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userPassword",
                "type": "uint256"
            },
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "userIdentity",
                "type": "string"
            },
            {
                "name": "userBalance",
                "type": "uint256"
            }
        ],
        "name": "updateUser",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index_userIndexAddresses",
                "type": "uint256"
            }
        ],
        "name": "getByIndex_userIndexAddresses",
        "outputs": [
            {
                "name": "userAddress",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "totalSupplyEthereum",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userPassword",
                "type": "uint256"
            },
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "userIdentity",
                "type": "string"
            },
            {
                "name": "userBalance",
                "type": "uint256"
            }
        ],
        "name": "insertUser",
        "outputs": [
            {
                "name": "index_userIndexAddresses",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getNumberUser",
        "outputs": [
            {
                "name": "numberUser",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userPassword",
                "type": "uint256"
            },
            {
                "name": "userAddressProducer",
                "type": "address"
            },
            {
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "name": "filmPrice",
                "type": "uint256"
            }
        ],
        "name": "buyFilm",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userPassword",
                "type": "uint256"
            }
        ],
        "name": "deleteUser",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userOldPassword",
                "type": "uint256"
            },
            {
                "name": "userNewPassword",
                "type": "uint256"
            }
        ],
        "name": "updateUserPassword",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "userAddress",
                "type": "address"
            },
            {
                "name": "userPassword",
                "type": "uint256"
            }
        ],
        "name": "getUser",
        "outputs": [
            {
                "name": "index_userIndexAddresses",
                "type": "uint256"
            },
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "userIdentity",
                "type": "string"
            },
            {
                "name": "userBalance",
                "type": "uint256"
            },
            {
                "name": "userBoughtFilm",
                "type": "uint256[]"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "userIndex",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "userAddress",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "userName",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "userIdentity",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "userBalance",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "userBoughtFilm",
                "type": "uint256[]"
            }
        ],
        "name": "logUser",
        "type": "event"
    }
]
            );


        var filmManagerContrat = web3.eth.contract(
[
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "name": "filmName",
                "type": "string"
            },
            {
                "name": "filmDescription",
                "type": "string"
            },
            {
                "name": "filmImageUrl",
                "type": "string"
            },
            {
                "name": "filmUrl",
                "type": "string"
            },
            {
                "name": "filmPrice",
                "type": "uint256"
            },
            {
                "name": "filmNumberVoir",
                "type": "uint256"
            },
            {
                "name": "filmNotation",
                "type": "uint256"
            },
            {
                "name": "filmPublished",
                "type": "bool"
            },
            {
                "name": "filmIco",
                "type": "bool"
            }
        ],
        "name": "updateFilm",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "getFilm",
        "outputs": [
            {
                "name": "filmName",
                "type": "string"
            },
            {
                "name": "filmDescription",
                "type": "string"
            },
            {
                "name": "filmImageUrl",
                "type": "string"
            },
            {
                "name": "filmUrl",
                "type": "string"
            },
            {
                "name": "filmPrice",
                "type": "uint256"
            },
            {
                "name": "filmNumberVoir",
                "type": "uint256"
            },
            {
                "name": "filmNotation",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "deleteFilm",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmName",
                "type": "string"
            },
            {
                "name": "filmDescription",
                "type": "string"
            },
            {
                "name": "filmImageUrl",
                "type": "string"
            },
            {
                "name": "filmUrl",
                "type": "string"
            },
            {
                "name": "filmPrice",
                "type": "uint256"
            },
            {
                "name": "filmNumberVoir",
                "type": "uint256"
            },
            {
                "name": "filmNotation",
                "type": "uint256"
            },
            {
                "name": "filmPublished",
                "type": "bool"
            },
            {
                "name": "filmIco",
                "type": "bool"
            },
            {
                "name": "userAddressProducer",
                "type": "address"
            }
        ],
        "name": "insertFilm",
        "outputs": [
            {
                "name": "index_filmIndexes",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getNumberFilm",
        "outputs": [
            {
                "name": "numberFilm",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "getFilmInfo_published_ico_producer",
        "outputs": [
            {
                "name": "filmIndex_return",
                "type": "uint256"
            },
            {
                "name": "filmPublished",
                "type": "bool"
            },
            {
                "name": "filmIco",
                "type": "bool"
            },
            {
                "name": "userAddressProducer",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index_filmIndexes",
                "type": "uint256"
            }
        ],
        "name": "getByIndex_filmIndexes",
        "outputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmName",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "filmDescription",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "filmImageUrl",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "filmUrl",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "filmPrice",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmNumberVoir",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmNotation",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmPublished",
                "type": "bool"
            },
            {
                "indexed": false,
                "name": "filmIco",
                "type": "bool"
            },
            {
                "indexed": false,
                "name": "userAddressProducer",
                "type": "address"
            }
        ],
        "name": "logFilm",
        "type": "event"
    }
]
        );

        var tokenManagerContrat = web3.eth.contract(
[
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "name": "filmBudget",
                "type": "uint256"
            },
            {
                "name": "filmMaturity",
                "type": "uint256"
            },
            {
                "name": "tokenPrice",
                "type": "uint256"
            },
            {
                "name": "tokenNumber",
                "type": "uint256"
            }
        ],
        "name": "updateToken",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "name": "filmBudget",
                "type": "uint256"
            },
            {
                "name": "filmMaturity",
                "type": "uint256"
            },
            {
                "name": "tokenPrice",
                "type": "uint256"
            },
            {
                "name": "tokenNumber",
                "type": "uint256"
            },
            {
                "name": "tokenRecommend",
                "type": "int256"
            }
        ],
        "name": "insertToken",
        "outputs": [
            {
                "name": "index_filmIndexes",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "minusOneTokenRecommend",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "deleteToken",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getNumberToken",
        "outputs": [
            {
                "name": "numberToken",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "addOneTokenRecommend",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index_filmIndexes",
                "type": "uint256"
            }
        ],
        "name": "getByIndex_filmIndexes",
        "outputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "filmIndex",
                "type": "uint256"
            }
        ],
        "name": "getToken",
        "outputs": [
            {
                "name": "index_filmIndexes",
                "type": "uint256"
            },
            {
                "name": "filmBudget",
                "type": "uint256"
            },
            {
                "name": "filmMaturity",
                "type": "uint256"
            },
            {
                "name": "tokenPrice",
                "type": "uint256"
            },
            {
                "name": "tokenNumber",
                "type": "uint256"
            },
            {
                "name": "tokenRecommend",
                "type": "int256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "filmIndex",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmBudget",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "filmMaturity",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "tokenPrice",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "tokenNumber",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "tokenRecommend",
                "type": "int256"
            }
        ],
        "name": "logToken",
        "type": "event"
    }
]
        );


        var userManager = userManagerContrat.at("0xed2092469de550a83d17dc723588be1c4e6e8a66");
        console.log("contract_userManager:");
        console.log(userManager);

        var filmManager = filmManagerContrat.at("0xfadaded098d31cba8af0a2778264e95dc47b02fb");
        console.log("contract_filmManager:");
        console.log(filmManager);

        var tokenManager = tokenManagerContrat.at("0xf5d29f2c203760fe1bbce1c339d4d37dcc150775");
        console.log("contract_tokenManager:");
        console.log(tokenManager);




        function test_userManager(userManager) {
            userManager.getNumberUser(function(error,result) {
                console.log("numberUser:");
                console.log(result.c[0]);

                userManager.getByIndex_userIndexAddresses(Math.round(Math.random()*(result.c[0]-1)), function(error,result){
                    if(!error){
                        var userAddress_return = result;
                        console.log("userAddress_return:"+userAddress_return);
                    } else {
                        console.log("error_getByIndex_userIndexAddresses:");
                        console.log(error);
                    }

                    userManager.getUser(userAddress_return, 123, function(error, result) {
                        if(!error){
                            console.log("result_getUser:"+userAddress_return+"->");
                            console.log(result);
                        } else {
                            console.log("error_getUser:"+userAddress_return+"->");
                            console.log(error);
                        }
                    });
                });
            });        
        }

        function test_insertUser(userManager) {
            userManager.insertUser("0x330b4dADd8a960C358cF49bbB8401eA720270D43","123","test_name","customer","50", 
                {
                    "from": web3.eth.defaultAccount, 
                    'gas': 6000000,
                }
                ,
                function(error, result) {
                    if(!error){
                            console.log("insertUser:");
                            console.log(result);
                        } else {
                            // console.log("error_insertUser:");
                            // console.log(error);
                            test_deleteUser(userManager);
                        }
                });
        }

        function test_deleteUser(userManager) {
            userManager.deleteUser("0x330b4dADd8a960C358cF49bbB8401eA720270D43","123", 
                {
                    "from": web3.eth.defaultAccount, 
                    'gas': 6000000,
                    "to": "0xed2092469de550a83d17dc723588be1c4e6e8a66"
                }
                ,
                function(error, result) {
                    if(!error){
                            console.log("deleteUser:");
                            console.log(result);
                        } else {
                            console.log("error_deleteUser:");
                            console.log(error);
                        }
                });
        }
        

        function test_filmManager(filmManager) {
            filmManager.getNumberFilm(function(error,result) {
                console.log("numberFilm:");
                console.log(result.c[0]);

                filmManager.getByIndex_filmIndexes(Math.round(Math.random()*(result.c[0]-1)), function(error,result){
                    if(!error){
                        var filmIndex_return = result;
                        console.log("filmIndex_return:"+filmIndex_return);
                    } else {
                        console.log("error_getByIndex_filmIndexes:");
                        console.log(error);
                    }

                    filmManager.getFilm(filmIndex_return, function(error, result) {
                        if(!error){
                            console.log("result_getFilm:"+filmIndex_return+"->");
                            console.log(result);
                        } else {
                            console.log("error_getFilm:"+filmIndex_return+"->");
                            console.log(error);
                        }

                        filmManager.getFilmInfo_published_ico_producer(filmIndex_return, function(error, result) {
                            if(!error){
                                console.log("result_getFilmInfo_published_ico_producer:"+filmIndex_return+"->");
                                console.log(result);
                            } else {
                                console.log("error_getFilmInfo_published_ico_producer:"+filmIndex_return+"->");
                                console.log(error);
                            }
                        });
                    });
                });
            });
        }

        function test_tokenManager(tokenManager) {
            tokenManager.getNumberToken(function(error,result) {
                console.log("numberToken:");
                console.log(result.c[0]);

                tokenManager.getByIndex_filmIndexes(Math.round(Math.random()*(result.c[0]-1)), function(error,result){
                    if(!error){
                        var filmIndex_return = result;
                        console.log("filmIndex_return:"+filmIndex_return);
                    } else {
                        console.log("error_getByIndex_filmIndexes:");
                        console.log(error);
                    }

                    tokenManager.getToken(filmIndex_return, function(error, result) {
                        if(!error){
                            console.log("result_getToken:"+filmIndex_return+"->");
                            console.log(result);
                        } else {
                            console.log("error_getToken:"+filmIndex_return+"->");
                            console.log(error);
                        }
                    });
                });
            });
        }

        test_userManager(userManager);

        setTimeout(function(){
            console.log("------------------------------------------------------");
            test_insertUser(userManager);
        }, 2000);

        // setTimeout(function(){
        //     console.log("------------------------------------------------------");
        //     test_filmManager();
        // }, 2000);

        // setTimeout(function(){
        //     console.log("------------------------------------------------------");
        //     test_tokenManager();
        // }, 5000);
    </script>

</body>
</html>