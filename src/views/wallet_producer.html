<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/ionicons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Actor">
    <link rel="stylesheet" href="assets/css/Animated-Pretty-Product-List-v12.css">
    <link rel="stylesheet" href="assets/css/Article-List.css">
    <link rel="stylesheet" href="assets/css/Block-Responsive-Item-List.css">
    <link rel="stylesheet" href="assets/css/Footer-Dark.css">
    <link rel="stylesheet" href="assets/css/Grid-and-List-view-V10.css">
    <link rel="stylesheet" href="assets/css/Grid-and-List-view-V10.css">
    <link rel="stylesheet" href="assets/css/Login-Form-Dark.css">
    <link rel="stylesheet" href="assets/css/Pretty-Registration-Form.css">
    <link rel="stylesheet" href="assets/css/Navigation-Clean.css">
    <link rel="stylesheet" href="assets/css/Navigation-with-Button.css">
    <link rel="stylesheet" href="assets/css/Profile-Card.css">
    <link rel="stylesheet" href="assets/css/Registration-Form-with-Photo.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
    <div class="article-list"></div>
    <div></div>
    <div></div>
    <div>
        <nav class="navbar navbar-light navbar-expand-md navigation-clean-button">
            <div class="container">
                <div id="username"></div><button class="navbar-toggler" data-toggle="collapse" data-target="#navcol-1"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse"
                     id="navcol-1">
                    <ul class="nav navbar-nav mr-auto">
                        <li class="nav-item" role="presentation"><a class="nav-link active" href="#"><div id="solde"></div></a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link active" href="#"><div id="identity"></div></a></li>
                    </ul><span class="navbar-text actions"> <a class="btn btn-light action-button" role="button" href="index.html" onclick="sessionStorage.clear();">Sign Out</a></span>
                </div>
            </div>
        </nav>
    </div>
    <div>
        <div class="profile-card">
            <div class="profile-back"></div><img class="rounded-circle profile-pic" src="assets/img/2.png">
            <ul class="social-list"></ul><a class="btn btn-primary" role="button" href="movie_form.html" style="margin:30px;width:272px;background-color:rgb(155,31,31);">Add a Movie</a><a class="btn btn-primary" role="button" href="ico_form.html" style="margin:30px;width:272px;background-color:rgb(155,31,31);">Create ICO's</a>
        </div>
    </div>
    <div class="article-list">
        <div class="container">
            <div class="intro">
                <h2 class="text-center">My ICO's</h2>
                <p class="text-center">Here are your investment !</p>
            </div>
            <div class="row articles" id="listTokens_forProducer">
                <!-- <div class="col-sm-6 col-md-4 flex-wrap item">
                    <a href="#"><img class="img-fluid" src="assets/img/desk.jpg"></a>
                    <h5>filmIndex: <span>3</span></h5>
                    <p>issue date: <span>1/1/1970</span></p>
                    <p>maturity date: <span>1/1/1970</span></p>
                    <p>investor's token number: <span>100</span></p>
                    <p>token price: <span>10</span></p>
                    <p>token Recommend: <span>0</span></p>
                    <button type="button" class="btn btn-primary mb-2" onclick="finishToken(filmIndex);">Finish token</button>
                </div>
                <div class="col-sm-6 col-md-4 item">
                    <a href="#"><img class="img-fluid" src="assets/img/building.jpg"></a>
                    <h3 class="name">MovieTitle2</h3>
                    <p class="description">ico data 2</p><a href="#" class="action"></a>
                </div>
                <div class="col-sm-6 col-md-4 item">
                    <a href="#"><img class="img-fluid" src="assets/img/loft.jpg"></a>
                    <h3 class="name">MovieTitle3</h3>
                    <p class="description">ico data 2</p><a href="#" class="action"></a>
                </div> -->
            </div>
        </div>
        <div class="container">
            <div class="intro">
                <h2 class="text-center">My Movies</h2>
                <p class="text-center">Your uploaded movies.</p>
            </div>

            <div class="row articles" id="listFilms_forProducer">
            </div>

            <!-- <div class="row articles">
                <div class="col-sm-6 col-md-4 flex-wrap item">
                    <img class="img-fluid" src="assets/img/desk.jpg">
                    <h5 class="name">filmIndex: <span>{filmIndex}</span></h5>
                    <p>filmName: <span>{filmName}</span></p>
                    <p>filmDescription: <span>{filmDescription}</span></p>
                    <p>filmPrice: <span>{filmPrice}</span></p>
                    <p>filmNumberVoir: <span>{filmNumberVoir}</span></p>
                    <p>filmNotation: <span>{filmNotation}</span></p>
                </div>
                <div class="col-sm-6 col-md-4 item">
                    <img class="img-fluid" src="assets/img/building.jpg">
                    <h3 class="name">MovieTitle2</h3>
                    <p class="description">ico data 2</p>
                </div>
                <div class="col-sm-6 col-md-4 item">
                    <img class="img-fluid" src="assets/img/loft.jpg">
                    <h3 class="name">MovieTitle3</h3>
                    <p class="description">ico data 2</p>
                </div>
            </div> -->

        </div>
    </div>
    <div class="footer-dark">
        <footer>
            <div class="container">
                <div class="row">
                    <div class="col-sm-6 col-md-3 item">
                        <h3>Services</h3>
                        <ul>
                            <li><a href="#">Web design</a></li>
                            <li><a href="#">Development</a></li>
                            <li><a href="#">Hosting</a></li>
                        </ul>
                    </div>
                    <div class="col-sm-6 col-md-3 item">
                        <h3>About</h3>
                        <ul>
                            <li><a href="#">Company</a></li>
                            <li><a href="#">Team</a></li>
                            <li><a href="#">Careers</a></li>
                        </ul>
                    </div>
                    <div class="col-md-6 item text">
                        <h3>KICKFLIX</h3>
                        <p>Praesent sed lobortis mi. Suspendisse vel placerat ligula. Vivamus ac sem lacus. Ut vehicula rhoncus elementum. Etiam quis tristique lectus. Aliquam in arcu eget velit pulvinar dictum vel in justo.</p>
                    </div>
                </div>
                <p class="copyright">Kickflix © 2019</p>
            </div>
        </footer>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/Animated-Pretty-Product-List-v12.js"></script>
    <script src="assets/js/Grid-and-List-view-V10.js"></script>



    <script src="../index.1_web3_smartContracts.js"></script>
    <script src="../index.2_smartContract_events.js"></script>
    <script src="../index.3_smarContractFunctions.js"></script>
    <script src="../index.4_testFunction.js"></script>
    <script src="../index.5_toolsFunction.js"></script>

    <script src='../functionAboutUserManager.js'></script>
    <script src='../functionAboutFilmManager.js'></script>
    <script src='../functionAboutTokenManager.js'></script>
    <script src='../functionAboutTokenDistributionForUserManager.js'></script>
    <script src='../functionAboutTokenDistributionForTokenManager.js'></script>


    <!-- token -->
    <script type="text/javascript">
        async function showListOfTokenMarket_forProducer(compte_producer, div_id, returnDataFunction) {
            var listTokens_forProducer = await returnDataFunction();
            // console.log(listTokens_forProducer);
            var block_ico = document.getElementById(div_id);

            block_html_ico = "";

            for (var item in listTokens_forProducer) {
                var oneTokenProducer = listTokens_forProducer[item]
                // console.log(oneTokenProducer);

                var distributionProducer = await getTokenForUser(await getUserAddressBy_userEmail(compte_producer.email), oneTokenProducer.filmIndex);
                // console.log(distributionProducer);

                block_html_ico +=
                    "<div class='col-sm-6 col-md-4 flex-wrap item'>" +
                    "<img class='img-fluid' src='" + random_img(imgs_web) + "' style='height:139.78px;'>" +
                    "<h5>filmIndex: <span>" + oneTokenProducer.filmIndex + "</span></h5>" +
                    "<p>issue date: <span>" + oneTokenProducer.filmIssueDate + "</span></p>" +
                    "<p>maturity date: <span>" + oneTokenProducer.filmMaturity + "</span></p>" +
                    "<p>token budget: <span>" + oneTokenProducer.tokenNumber * oneTokenProducer.tokenPrice + "</span></p>" +
                    "<p>total token number: <span>" + oneTokenProducer.tokenNumber + "</span></p>" +
                    "<p>producer's token number: <span>" + distributionProducer.numberToken_user + "</span></p>" +
                    "<p>investor's token number: <span>" + (oneTokenProducer.tokenNumber - distributionProducer.numberToken_user) + "</span></p>" +
                    "<p>token price current: <span>" + (oneTokenProducer.tokenPrice + 1 * oneTokenProducer.tokenRecommend) + "</span></p>" +
                    "<p>token Recommend: <span>" + oneTokenProducer.tokenRecommend + "</span></p>" +
                    "<button type='button' class='btn btn-primary mb-2' onclick=\"finishToken_pageProducer('" + oneTokenProducer.filmIndex + "');\">Finish token</button>" +
                    "</div>";
            }

            block_ico.innerHTML = block_html_ico;

        }

        async function returnListTokens_forProducer(userEmailProducer_input) {
            var listTokens_forProducer = [];

            var numberFilm = await getNumberFilm();
            // console.log(numberFilm);

            for (var i = 0; i < numberFilm; i++) {
                try {
                    var filmIndex = await getByIndex_filmIndexes_filmManager(i);
                    var film_ICO = await getFilmInfo_published_ico_producer(filmIndex);
                    // console.log(film_ICO);
                    if (film_ICO.filmIco == true && film_ICO.userEmailProducer == userEmailProducer_input) {
                        var tokenInfo = await getToken(film_ICO.filmIndex);
                        tokenInfo["filmIco"] = film_ICO.filmIco;
                        tokenInfo["filmPublished"] = film_ICO.filmPublished;
                        tokenInfo["userEmailProducer"] = film_ICO.userEmailProducer;

                        listTokens_forProducer.push(tokenInfo);
                    }
                } catch(error) {
                    console.log("filmIndex: "+filmIndex+" doesn't existe");
                }
            }
            // console.log(listTokens_forProducer);
            return listTokens_forProducer;
        }

        async function finishToken_pageProducer(filmIndex) {
            // console.log(filmIndex);

            var filmInfo = await getFilm(filmIndex);
            console.log(filmInfo);
            var filmInfo_Ico = await getFilmInfo_published_ico_producer(filmIndex);
            console.log(filmInfo_Ico);
            var tokenInfo = await getToken(filmIndex);
            console.log(tokenInfo);

            var userAddressProducer = await getUserAddressBy_userEmail(filmInfo_Ico.userEmailProducer);
            var distributionUserAddress_forOneToken = (await getTokenAndAllUsers(filmIndex)).boughtUserAddresses;
            // console.log(distributionUserAddress_forOneToken);

            var distributionUser_forOneToken = await sumDistribution(filmIndex, distributionUserAddress_forOneToken, userAddressProducer, tokenInfo.tokenNumber, tokenInfo.tokenPrice + 1 * tokenInfo.tokenRecommend);
            // console.log(distributionUser_forOneToken);


            // pay back many -> number of investor
            await payBackInvestor(compte_producer.email, compte_producer.password, distributionUser_forOneToken);

            // Distribution -> 2 click
            await deleteTokenDistribution(distributionUser_forOneToken);

            // tokenManager 
            await deleteToken_TokenManager(filmIndex)

            // publish film
            await publishFilm(filmIndex);


        }

        async function sumDistribution(filmIndex, distributionUser_forOneToken, userAddressProducer, tokenNumberTotal, tokenPriceCurrent) {
            var sum = {
                "filmIndex": filmIndex,
                "tokenNumberTotal": tokenNumberTotal,
                "tokenPriceCurrent": tokenPriceCurrent,
                "distributionUser": []
            };

            var list_email_and_address = await getList_email_and_address();
            // console.log(list_email_and_address)

            // user info
            for (var item in distributionUser_forOneToken) {
                var userAddress = distributionUser_forOneToken[item];
                var token_user = await getTokenForUser(userAddress, filmIndex);
                // console.log(token_user);
                oneUser = {
                    "identity": (token_user.userAddress == userAddressProducer) ? "producer" : "consumer",
                    "userAddress": token_user.userAddress,
                    "numberToken_user": token_user.numberToken_user,
                };

                // add userEmail
                for (var item in list_email_and_address) {
                    var element = list_email_and_address[item];
                    if (element.userAddress == oneUser.userAddress) {
                        oneUser.userEmail = element.userEmail;
                    }
                }

                sum.distributionUser.push(oneUser);
            }

            // calculate the money pay back
            for (var item in sum.distributionUser) {
                var token_user = sum.distributionUser[item];
                if (token_user == "producer") {
                    sum.distributionUser[item].changeMoney = tokenPriceCurrent * (sum.tokenNumberTotal - token_user.numberToken_user);
                } else {
                    sum.distributionUser[item].changeMoney = tokenPriceCurrent * token_user.numberToken_user;
                }
            }

            // console.log(sum);
            return sum;
        }

        async function payBackInvestor(userEmailProducer, userPassword, distributionUser_forOneToken) {
            console.log(distributionUser_forOneToken);
            var users = distributionUser_forOneToken.distributionUser;
            for (var item in users) {
                // console.log(users[item]);
                if (users[item].identity == "consumer") {
                    var consumer = users[item];
                    // console.log(consumer);

                    // pay back many
                    await finishToken(userEmailProducer, userPassword, consumer.userEmail, consumer.changeMoney);
                }
            }
        }

        async function deleteTokenDistribution(distributionUser_forOneToken) {
            console.log(distributionUser_forOneToken);
            var filmIndex = distributionUser_forOneToken.filmIndex;
            var distributionUser = distributionUser_forOneToken.distributionUser;

            for (var item in distributionUser) {
                console.log(distributionUser[item]);
                // DistributionForUserManager
                await deleteToken_DistributionForUserManager(distributionUser[item].userAddress, filmIndex);
            }

            // DistributionForTokenManager
            await deleteToken_DistributionForTokenManager(filmIndex);


        }

        async function publishFilm(filmIndex) {
            var filmInfo = await getFilm(filmIndex);
            console.log(filmInfo);
            var filmInfo_Ico = await getFilmInfo_published_ico_producer(filmIndex);
            filmInfo_Ico.filmPublished = true;
            filmInfo_Ico.filmIco = false;
            console.log(filmInfo_Ico);

            await updateFilm(filmInfo.filmIndex, filmInfo.filmName, filmInfo.filmDescription, filmInfo.filmImageUrl, filmInfo.filmUrl, filmInfo.filmPrice, filmInfo.filmNumberVoir, filmInfo.filmNotation, filmInfo_Ico.filmPublished, filmInfo_Ico.filmIco);
        }
    </script>


    <!-- film -->
    <script type="text/javascript">
        async function showListOfFilms_forProducer(compte_producer, div_id) {
            var listFilms_forProducer = await returnListFilms_forProducer(compte_producer.email);
            // console.log(listFilms_forProducer);
            

            var block = document.getElementById(div_id);

            block_html = "";


            for (var item in listFilms_forProducer) {
                var oneFilmProducer = listFilms_forProducer[item]
                // console.log(oneFilmProducer);

                block_html +=
                    "<div class='col-sm-6 col-md-4 flex-wrap item'>"+
                        "<img class='img-fluid' src='"+random_img(imgs_web)+"'>"+
                        "<h5 class='name'>filmIndex: <span>"+oneFilmProducer.filmIndex+"</span></h5>"+
                        "<p>filmName: <span>"+oneFilmProducer.filmName+"</span></p>"+
                        "<p>filmDescription: <span>"+oneFilmProducer.filmDescription+"</span></p>"+
                        "<p>filmPrice: <span>"+oneFilmProducer.filmPrice+"</span></p>"+
                        "<p>filmNumberVoir: <span>"+oneFilmProducer.filmNumberVoir+"</span></p>"+
                        "<p>filmNotation: <span>"+oneFilmProducer.filmNotation+"</span></p>"+
                    "</div>";
            }

            block.innerHTML = block_html;

        }

        async function returnListFilms_forProducer(userEmailProducer) {
            var listFilms_forProducer = [];
            console.log(userEmailProducer);

            var numberFilm = await getNumberFilm();
            // console.log(numberFilm);

            for (var i = 0; i < numberFilm; i++) {
                try {
                    var filmIndex = await getByIndex_filmIndexes_filmManager(i);
                    var filmInfo = await getFilm(filmIndex);
                    var filmInfo_Ico = await getFilmInfo_published_ico_producer(filmIndex);
                    // console.log(filmInfo_Ico);
                    if (filmInfo_Ico.userEmailProducer == userEmailProducer && filmInfo_Ico.filmPublished == true) {
                        listFilms_forProducer.push(filmInfo);
                    }
                } catch(error) {
                    console.log("filmIndex: "+filmIndex+" doesn't existe");
                }
                
            }

            return listFilms_forProducer;
        }
    </script>

    <script>


        // var compte_producer = {
        //     "email": getSession().email,
        //     "password": getSession().password,
        // }

        var compte_producer = getUserFromSession();
        console.log(compte_producer);

        profil(userManager);
        
        showListOfTokenMarket_forProducer(compte_producer, "listTokens_forProducer", async () => { return await returnListTokens_forProducer(compte_producer.email) });

        showListOfFilms_forProducer(compte_producer, "listFilms_forProducer");


    </script>

</body>

</html>